pipeline {
    agent any
    
    environment {
        // URLs de los repositorios (configurar en Jenkins)
        BACKEND_REPO_URL = 'https://github.com/sebaveaa/stock-simulator-springQA'
        FRONTEND_REPO_URL = 'https://github.com/Brillem/stock-simulator-angular'
        
        // Configuración de base de datos para pruebas
        DB_HOST = 'postgres-test'
        DB_PORT = '5432'
        DB_NAME = 'postgres'
        DB_USERNAME = 'postgres'
        DB_PASSWORD = 'postgres'
        
        // Configuración del backend
        SERVER_PORT = '8080'
        JPA_DDL_AUTO = 'create-drop'
        JPA_SHOW_SQL = 'false'
        
        // Directorios de trabajo
        BACKEND_DIR = 'backend'
        FRONTEND_DIR = 'frontend'
        REPORTS_DIR = 'test-reports'
    }
    
    stages {
        stage('Checkout Repositorios') {
            steps {
                script {
                    echo 'Clonando repositorios backend y frontend...'
                    
                    // Clonar backend
                    dir("${BACKEND_DIR}") {
                        git branch: 'main', 
                            url: "${BACKEND_REPO_URL}",
                            credentialsId: 'github-credentials' // Configurar en Jenkins si el repo es privado
                    }
                    
                    // Clonar frontend
                    dir("${FRONTEND_DIR}") {
                        git branch: 'main', 
                            url: "${FRONTEND_REPO_URL}",
                            credentialsId: 'github-credentials' // Configurar en Jenkins si el repo es privado
                    }
                }
            }
        }
        
        stage('Preparar Entorno') {
            steps {
                script {
                    echo 'Preparando entorno de pruebas...'
                    sh '''
                        mkdir -p ${REPORTS_DIR}
                        mkdir -p ${REPORTS_DIR}/backend
                        mkdir -p ${REPORTS_DIR}/frontend
                    '''
                }
            }
        }
        
        stage('Iniciar PostgreSQL') {
            steps {
                script {
                    echo 'Iniciando PostgreSQL para pruebas...'
                    sh '''
                        # Verificar si postgres-test ya está corriendo
                        if docker ps | grep -q postgres-test; then
                            echo "PostgreSQL para pruebas ya está corriendo"
                        else
                            # Intentar usar docker-compose o docker compose
                            COMPOSE_FILE="docker-compose.jenkins.yml"
                            
                            # Verificar si el archivo existe en el directorio actual
                            if [ ! -f "$COMPOSE_FILE" ]; then
                                # Buscar en el directorio padre o en /workspace
                                if [ -f "../$COMPOSE_FILE" ]; then
                                    COMPOSE_FILE="../$COMPOSE_FILE"
                                elif [ -f "/workspace/ProyectoQA/$COMPOSE_FILE" ]; then
                                    COMPOSE_FILE="/workspace/ProyectoQA/$COMPOSE_FILE"
                                fi
                            fi
                            
                            echo "Usando archivo: $COMPOSE_FILE"
                            
                            # Intentar iniciar con docker compose (v2) o docker-compose (v1)
                            if command -v docker-compose >/dev/null 2>&1; then
                                docker-compose -f "$COMPOSE_FILE" up -d postgres-test || true
                            elif docker compose version >/dev/null 2>&1; then
                                docker compose -f "$COMPOSE_FILE" up -d postgres-test || true
                            else
                                # Si no hay docker-compose, iniciar el contenedor directamente
                                echo "docker-compose no disponible, iniciando contenedor directamente..."
                                docker run -d \
                                    --name jenkins-postgres-test \
                                    --network jenkins-network \
                                    -e POSTGRES_DB=postgres \
                                    -e POSTGRES_USER=postgres \
                                    -e POSTGRES_PASSWORD=postgres \
                                    -p 5433:5432 \
                                    postgres:15-alpine || \
                                echo "No se pudo iniciar PostgreSQL - puede que ya esté corriendo o falten permisos"
                            fi
                        fi
                        
                        # Esperar a que PostgreSQL esté listo
                        echo "Esperando a que PostgreSQL esté listo..."
                        for i in {1..30}; do
                            if docker exec jenkins-postgres-test pg_isready -U postgres >/dev/null 2>&1 2>/dev/null; then
                                echo "PostgreSQL está listo"
                                break
                            fi
                            sleep 1
                        done
                        
                        # Verificar que PostgreSQL está corriendo
                        docker ps | grep postgres-test || echo "Advertencia: PostgreSQL no está corriendo como contenedor"
                    '''
                }
            }
        }
        
        stage('Pruebas Backend') {
            steps {
                script {
                    echo 'Ejecutando pruebas del backend...'
                    dir("${BACKEND_DIR}") {
                        try {
                            sh '''
                                mvn clean test \
                                    -Dspring.datasource.url=jdbc:postgresql://postgres-test:5432/postgres \
                                    -Dspring.datasource.username=postgres \
                                    -Dspring.datasource.password=postgres \
                                    -Dspring.jpa.hibernate.ddl-auto=create-drop \
                                    -Dspring.jpa.show-sql=false
                            '''
                        } catch (Exception e) {
                            echo "Error en pruebas backend: ${e.getMessage()}"
                            currentBuild.result = 'UNSTABLE'
                        } finally {
                            // Generar reporte CSV de pruebas backend
                            sh '''
                                mvn surefire-report:report || true
                                python3 ../jenkins/scripts/generate_backend_report.py || python ../jenkins/scripts/generate_backend_report.py || echo "No se pudo generar reporte CSV del backend"
                            '''
                            // Copiar reportes
                            sh '''
                                cp -r target/surefire-reports/* ../${REPORTS_DIR}/backend/ 2>/dev/null || true
                                cp target/surefire-reports/*.csv ../${REPORTS_DIR}/backend/ 2>/dev/null || true
                            '''
                        }
                    }
                }
            }
        }
        
        stage('Pruebas Frontend') {
            steps {
                script {
                    echo 'Ejecutando pruebas del frontend...'
                    dir("${FRONTEND_DIR}") {
                        try {
                            sh '''
                                npm install
                                npm test -- --watch=false --browsers=ChromeHeadless --code-coverage --reporters=progress,junit
                            '''
                        } catch (Exception e) {
                            echo "Error en pruebas frontend: ${e.getMessage()}"
                            currentBuild.result = 'UNSTABLE'
                        } finally {
                            // Generar reporte CSV de pruebas frontend
                            sh '''
                                python3 ../jenkins/scripts/generate_frontend_report.py || python ../jenkins/scripts/generate_frontend_report.py || echo "No se pudo generar reporte CSV del frontend"
                            '''
                            // Copiar reportes
                            sh '''
                                cp -r coverage/* ../${REPORTS_DIR}/frontend/ 2>/dev/null || true
                                cp *.csv ../${REPORTS_DIR}/frontend/ 2>/dev/null || true
                                find . -name "*.csv" -exec cp {} ../${REPORTS_DIR}/frontend/ \\; 2>/dev/null || true
                            '''
                        }
                    }
                }
            }
        }
        
        stage('Iniciar Backend para Pruebas de Carga') {
            when {
                anyOf {
                    environment name: 'RUN_LOAD_TESTS', value: 'true'
                    branch 'main'
                }
            }
            steps {
                script {
                    echo 'Iniciando backend para pruebas de carga...'
                    sh '''
                        # Verificar si backend ya está corriendo
                        if curl -f http://localhost:8080/actuator/health 2>/dev/null; then
                            echo "Backend ya está corriendo"
                        else
                            echo "Iniciando backend con docker-compose..."
                            # Usar docker-compose principal o iniciar contenedor backend
                            if [ -f "../docker-compose.yml" ]; then
                                cd ..
                                docker-compose up -d backend postgres 2>/dev/null || docker compose up -d backend postgres 2>/dev/null || echo "No se pudo iniciar con docker-compose"
                            elif [ -f "docker-compose.yml" ]; then
                                docker-compose up -d backend postgres 2>/dev/null || docker compose up -d backend postgres 2>/dev/null || echo "No se pudo iniciar con docker-compose"
                            fi
                            
                            # Esperar a que el backend esté listo
                            echo "Esperando a que el backend esté listo..."
                            for i in {1..60}; do
                                if curl -f http://localhost:8080/actuator/health 2>/dev/null; then
                                    echo "Backend está listo"
                                    break
                                fi
                                sleep 2
                            done
                        fi
                    '''
                }
            }
        }
        
        stage('Pruebas de Carga') {
            when {
                anyOf {
                    environment name: 'RUN_LOAD_TESTS', value: 'true'
                    branch 'main'
                }
            }
            steps {
                script {
                    dir('jenkins') {
                        sh '''
                            # Verificar que el backend esté disponible
                            if ! curl -f http://localhost:8080/actuator/health 2>/dev/null; then
                                echo "Error: Backend no está disponible para pruebas de carga"
                                exit 1
                            fi
                            
                            # Ejecutar pruebas de carga
                            ./scripts/run_load_tests.sh --scenario normal --backend-url http://localhost:8080 || echo "Pruebas de carga fallaron"
                        '''
                    }
                }
            }
            post {
                always {
                    script {
                        echo 'Publicando reportes de pruebas de carga...'
                        archiveArtifacts artifacts: 'jenkins/load-tests/load-test-reports/**/*', allowEmptyArchive: true
                        // Publicar reporte HTML (requiere plugin HTML Publisher)
                        // publishHTML([
                        //     reportDir: 'jenkins/load-tests/load-test-reports',
                        //     reportFiles: '**/index.html',
                        //     reportName: 'Load Test Report',
                        //     allowMissing: true
                        // ])
                    }
                }
            }
        }
        
        stage('Generar Reporte Consolidado') {
            steps {
                script {
                    echo 'Generando reporte consolidado CSV...'
                    sh '''
                        python3 jenkins/scripts/generate_consolidated_report.py || python jenkins/scripts/generate_consolidated_report.py || echo "No se pudo generar reporte consolidado"
                    '''
                }
            }
        }
        
        stage('Limpiar') {
            steps {
                script {
                    echo 'Limpiando contenedores de prueba...'
                    sh '''
                        # Detener PostgreSQL de pruebas
                        if docker ps | grep -q postgres-test; then
                            COMPOSE_FILE="docker-compose.jenkins.yml"
                            
                            # Verificar si el archivo existe en el directorio actual
                            if [ ! -f "$COMPOSE_FILE" ]; then
                                if [ -f "../$COMPOSE_FILE" ]; then
                                    COMPOSE_FILE="../$COMPOSE_FILE"
                                elif [ -f "/workspace/ProyectoQA/$COMPOSE_FILE" ]; then
                                    COMPOSE_FILE="/workspace/ProyectoQA/$COMPOSE_FILE"
                                fi
                            fi
                            
                            # Intentar detener con docker-compose
                            if command -v docker-compose >/dev/null 2>&1; then
                                docker-compose -f "$COMPOSE_FILE" stop postgres-test 2>/dev/null || true
                            elif docker compose version >/dev/null 2>&1; then
                                docker compose -f "$COMPOSE_FILE" stop postgres-test 2>/dev/null || true
                            fi
                            
                            # Detener el contenedor directamente si todavía está corriendo
                            docker stop jenkins-postgres-test 2>/dev/null || true
                            echo "PostgreSQL de pruebas detenido"
                        else
                            echo "PostgreSQL de pruebas no estaba corriendo"
                        fi
                    '''
                }
            }
        }
    }
    
    post {
        always {
            script {
                echo 'Publicando reportes...'
                archiveArtifacts artifacts: 'test-reports/**/*', allowEmptyArchive: true
                junit testResultsPattern: 'test-reports/**/*.xml', allowEmptyResults: true
            }
        }
        success {
            echo 'Pipeline ejecutado exitosamente'
        }
        failure {
            echo 'Pipeline falló'
        }
        unstable {
            echo 'Pipeline completado con advertencias'
        }
    }
}
